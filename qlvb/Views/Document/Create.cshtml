@model qlvb.Models.document

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<div id=showlookup style="display:block;float:right;position:fixed;top:0;right:0;z-index:2001;">
    <img src="/Images/lookup.png" onclick="showlookup();" style="cursor:pointer;">
</div>
<div id=lookup style="width:50%;display:block;float:left;position:fixed;top:40%;left:25%;background-color:blue;color:#fff;z-index:1001;text-align:center;display:none;">
    <label class="label" id="lookuplabel" style="color:#fff">Tra cứu *:</label><input type="text" class="form-control" placeholder="Nhập giá trị" id="lookupvalue" name="lookupvalue" style="width:100%;display:block;float:left;position:relative;border-color:#808080" onkeyup="autosearch(event,2);">
</div> 
<div id=addnewcat style="width:50%;display:block;float:left;position:fixed;top:40%;left:25%;background-color:#c8e19b;z-index:1001;text-align:center;display:none;">
    <label class="label" id="addnewcatlabel">Thêm mới *:</label><input type="text" class="form-control" placeholder="Nhập giá trị" id="addvalue" name="addvalue" style="width:100%;display:block;float:left;position:relative;border-color:#808080" >
    <input type="button" value="Thêm mới" onclick="addnewcat();" id="addnewcatbtn" class="btn btn-primary tf-btn color" style="position:relative; width:100px;"/>
    <input type="button" value="Đóng lại" onclick="$('#addnewcat').hide();" class="btn btn-primary tf-btn color" style="position:relative; width:100px;"/>
</div>    
<div id="progressbar" class="progressbar" style="width:50%;float:left;position:fixed;top:40%;left:25%;background-color:#c8e19b;z-index:1002;text-align:center;display:block;display:none">
      <div id="progresslabel" class="progressbarlabel" style="width:100%;float:left;height:100px;background-color:#ff6a00;color:#ffffff;">
          <div id="progresslabelpr" style="width:100%;float:left;height:100px;background-color:blue;color:#ffffff;position:absolute;text-align:center;font-size:24px"></div>
      </div>
</div>
<div id="tf-services" style="width:100%;padding-top:30px;">
<div class="container">
<h2>Thêm mới Văn bản</h2>
<script>
    var currentTypeCat = 1;
    var idDocument=@ViewBag.id;
    //var keyword1="";
    //var keyword2="";
    
    function getCat(type, id) {
        var formdata = new FormData(); //FormData object
        formdata.append("type", type);
        //showLoadingImage();
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/Home/getCat');
        xhr.send(formdata);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var sl = "<option value=-2 selected>Chọn</option>";
                var news = '{"news":' + xhr.responseText + '}';
                var json_parsed = $.parseJSON(news);
                //alert(xhr.responseText);
                for (var i = 0; i < json_parsed.news.length; i++) {
                    if (json_parsed.news[i]) {
                        var name = json_parsed.news[i].name;
                        var iditem = json_parsed.news[i].id;
                        sl += "<option value=" + iditem + ">" + name + "</option>";
                    }
                }

                switch (type) {
                    case 1:
                        $("#cat1").html(sl);
                        if (id!=-1) $("#cat1").val(id);
                        $("#cat1").append("<option value=-1>Click để thêm mới vào danh sách</option>");
                        break;
                    case 2:
                        $("#cat2").html(sl);
                        if (id != -1) $("#cat2").val(id);
                        $("#cat2").append("<option value=-1>Click để thêm mới vào danh sách</option>");
                        break;
                    case 3:
                        $("#cat3").html(sl);
                        if (id != -1) $("#cat3").val(id);
                        $("#cat3").append("<option value=-1>Click để thêm mới vào danh sách</option>");
                        break;
                    case 4:
                        $("#cat4").html(sl);
                        if (id != -1) $("#cat4").val(id);
                        $("#cat4").append("<option value=-1>Click để thêm mới vào danh sách</option>");
                        break;
                }
                
              
                
                
            }
        }
        return false;
    }
</script>
<div id="tf-services">
    <div class="container">
        <div style="width:100%;">
        <label class="label">Chọn file *:</label><input name="imageFile" type="file" id="imageFile" value="" multiple="multiple" class="form-control" runat="server" onchange="uploadProcess();"/>                                
        
        @*<iframe id="namelabel" src="" class="form-control" style="width:100%;display:none;float:left;position:relative;height:400px;"></iframe>      *@
        <a style="width:100%;display:none;float:left;position:relative;color:blue;text-decoration:solid;" id="viewdoc" target="_blank" href="https://docs.google.com/viewer?url=@qlvb.Config.domain/Files/@ViewBag.link">Upload thành công, Xem toàn văn nội dung</a>            
        <label class="label">Ký hiệu *:</label><input type="text" class="form-control" placeholder="Nhập ký hiệu văn bản: ví dụ 72/2015/TT-BTNMT" id="code" name="code" value="@ViewBag.code" style="width:100%;display:block;float:left;position:relative;" >
        <label class="label">Ngày ban hành *:</label><input type="date" id="date_publish" name="date_publish" class="form-control" value="@ViewBag.date_publish">  
        <label class="label">Tiêu đề *:(<img src="/Images/lw.png" style="width:16px;height:16px;cursor:pointer;" onclick="tolower();">)</label><textarea class="form-control" placeholder="Nhập tiêu đề văn bản" id="name" name="name" style="width:100%;display:block;float:left;position:relative;" rows="4">@Html.Raw(@ViewBag.name)</textarea>
        <label class="label">Văn bản căn cứ:</label><input type="text" class="form-control" placeholder="Nhập các mã văn bản, ngăn cách nhau dấu ," id="be_linked" name="be_linked" value="@ViewBag.be_linked" onkeyup="autosearch(event,1);" style="width:100%;display:block;float:left;position:relative;">
        <label class="label">Tập từ khóa 1(Lấy từ title của văn bản) *:</label><input type="text" class="form-control" placeholder="Lấy các từ khóa từ title văn bản" id="keyword1" name="keyword1" value="@Html.Raw(@ViewBag.keyword1)">
        <label class="label">Tập từ khóa 2(Lấy từ điều 1, điều 2 của văn bản) *:</label><textarea class="form-control" placeholder="Lấy từ điều 1, điều 2 của văn bản" id="keyword2" name="keyword2" rows="4">@Html.Raw(@ViewBag.keyword2)</textarea>
        <label class="label">Tập từ khóa 3(Lấy từ chương 1, chương 2 của văn bản) *:</label><textarea class="form-control" placeholder="Lấy từ chương 1, chương 2 của văn bản" id="keyword3" name="keyword3" rows="4">@Html.Raw(@ViewBag.keyword3)</textarea>
        <label class="label">Tập từ khóa 4(Lấy từ các từ khóa lặp đi lặp lại nhiều của văn bản) *:</label><textarea class="form-control" placeholder="Các từ khóa lặp đi lặp lại nhiều trong văn bản" id="keyword4" name="keyword4">@Html.Raw(@ViewBag.keyword4)</textarea>
        <label class="label">Văn bản liên quan *:</label><textarea class="form-control" placeholder="Các ký hiệu của văn bản khác xuất hiện trong văn bản này" id="keyword5" name="keyword5" rows="8">@Html.Raw(@ViewBag.keyword5)</textarea>
        <label class="label" >Văn bản sửa đổi bổ sung:</label><input type="text" class="form-control" placeholder="Nhập các mã văn bản, ngăn cách nhau dấu ," id="link_to" name="link_to" value="@ViewBag.link_to" onkeyup="autosearch(event,0);" style="width:100%;display:block;float:left;position:relative;">
        <label class="label">Văn bản hết hiệu lực:</label><input type="text" class="form-control" placeholder="Nhập các mã văn bản, ngăn cách nhau dấu ," id="link_to_over_date" name="link_to_over_date" value="@ViewBag.link_to_over_date" onkeyup="autosearch(event,2);" style="width:100%;display:block;float:left;position:relative;">
        <label class="label">Lĩnh vực *:</label><select id="cat1" name="cat1" class="form-control" onchange="chooseCat(1);"></select>
        <script>getCat(1,"@ViewBag.cat1");</script>
        <label class="label">Loại văn bản *:</label><select id="cat2" name="cat2" class="form-control" onchange="chooseCat(2);"></select>       
        <script>getCat(2,"@ViewBag.cat2");</script>
        <label class="label">Người ký *:</label><select id="cat3" name="cat3" class="form-control" onchange="chooseCat(3);"></select>
        <script>getCat(3,"@ViewBag.cat3");</script>
        <label class="label">Cơ quan ban hành *:</label><select id="cat4" name="cat4" class="form-control" onchange="chooseCat(4);"></select> 
        <script>getCat(4, "@ViewBag.cat4");</script>   
        <label class="label">Năm ban hành *:</label><select id="year" name="year" class="form-control" onchange="chooseCat(4);"></select> 
        <script>getYear(@ViewBag.year);</script>
         
        <label class="label">Ngày có hiệu lực *:</label><input type="date" id="date_start" name="date_start" class="form-control" value="@ViewBag.date_start">  
        <label class="label">Còn hay hết hiệu lực *:</label><input type="checkbox" id="status" name="status" checked class="form-control">Còn hiệu lực 
        @*<label class="label">Toàn văn *:</label><script src="/Scripts/ckeditor/ckeditor.js"></script>   
            <textarea name="full_content" id="full_content" rows="9"></textarea>
            <script>
                CKEDITOR.replace('full_content');
            </script>*@      
            <div id="pr" style="position:relative; width:100%;">
                <h4>QUẢN LÝ CHƯƠNG ĐIỀU</h4>                
                <div id="dvprice">
                    <table id="tblIndex" class="table table-striped table-bordered table-hover">
                        <tr class="odd gradeX" id=rowsIndex1 style="display:block;">
                            <td>Chương :<input type="text" id="chIndex1" value="1">&nbsp;Điều :<input type="text" id="dIndex1" value="1"></td>
                            <td style="width:100%;"><textarea id="cbIndex1" placeholder="Nội dung" style="width:100%;" rows="5"></textarea></td>
                            <td><a onclick="delIndex(1);" style="cursor:pointer;">Delete</a></td>
                        </tr>
                    </table>
                    <span style="float:left;"><a onclick="addIndex();" style="cursor:pointer;">+ Thêm chương điều</a></span>
                </div>
            </div>
        <input type="hidden" id="keyword2" name="keyword2" value="@ViewBag.keyword2">
        <input type="hidden" id="link" name="link" value="@ViewBag.link">
        <input type="hidden" id="related_id" name="related_id" value="@ViewBag.related_id">  
                 
        
        @*<label class="label">Tập từ khóa quan trọng 2:</label><textarea  class="form-control" placeholder="Những từ khóa key có độ quan trọng cao thứ nhì do phần mềm tự động nhận dạng" id="keyword2" name="keyword2" style="width:100%;display:block;float:left;position:relative;" ></textarea>
        <label class="label">Tập từ khóa quan trọng 3:</label><textarea  class="form-control" placeholder="Những từ khóa key có độ quan trọng cao thứ ba do phần mềm tự động nhận dạng" id="keyword3" name="keyword3" style="width:100%;display:block;float:left;position:relative;" ></textarea>*@

        </div>
        <div style="width:100%;position:relative;float:left;display:block;"><input type="button" id="btnAddNew" value="Save All" onclick="addNewDocument();" class="btn btn-primary tf-btn color" style="position:relative; width:100px;" /> <a href="/Document/Index">&nbsp;Quay lại danh sách</a></div>
    </div>
</div>
<script>
    if (idDocument!=-1) $("#viewdoc").show();
    if ("@ViewBag.status"=="0") 
    {document.getElementById("status").checked=true;} else {document.getElementById("status").checked=false;}
    var rowsIndex=1;
    var chIndex=1;
    var dIndex=1;
    function addIndex(){
        if (document.getElementById("chIndex"+rowsIndex)){
            chIndex=parseInt(document.getElementById("chIndex"+rowsIndex).value);
            dIndex=parseInt(document.getElementById("dIndex"+rowsIndex).value)+1;
        }
        rowsIndex++;        
        var row='<tr class="odd gradeX" id=rowsIndex'+rowsIndex+' style="display:block;">';
        row+="<td>Chương :<input type=\"text\" id=\"chIndex"+rowsIndex+"\" value=\""+chIndex+"\">&nbsp;Điều :<input type=\"text\" id=\"dIndex"+rowsIndex+"\" value=\""+dIndex+"\"></td><td style=\"width:100%;\"><textarea id=\"cbIndex"+rowsIndex+"\" placeholder=\"Nội dung\" style=\"width:100%;\" rows=\"5\"></textarea></td>";      
        row+="<td><a onclick=\"delIndex("+rowsIndex+");\" style=\"cursor:pointer;\">Delete</a></td>";
        row+="</tr>";
        $("#tblIndex").append(row);
        //alert(row);
    }
    function delIndex(index){
        document.getElementById("rowsIndex"+index).style.display='none';
    }
    function getDI(id) {
        if ("-1"=="@ViewBag.id") return;
        var formdata = new FormData(); //FormData object
        formdata.append("id", id);        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/Document/getGI');
        xhr.send(formdata);
        $("#tblIndex").html("<img src='/Images/loading.gif'>");
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {  
                if (xhr.responseText=="0") return;
                var news = '{"news":' + xhr.responseText + '}';
                var json_parsed = $.parseJSON(news);     
                var contentAll="";
                rowsIndex=0;               
                for (var i = 0; i < json_parsed.news.length; i++) {
                    if (json_parsed.news[i]) {
                        var name = json_parsed.news[i];
                        var index=i+1;
                        var arr=name.item_id.split("_");
                        var ch=arr[0]; var d=arr[1];
                        var row='<tr class="odd gradeX" id=rowsIndex'+index+' style="display:block;">';
                        row+="<td>Chương :<input type=\"text\" id=\"chIndex"+index+"\" value=\""+ch+"\">&nbsp;Điều :<input type=\"text\" id=\"dIndex"+index+"\" value=\""+d+"\"></td><td style=\"width:100%;\"><textarea id=\"cbIndex"+index+"\" placeholder=\"Nội dung\" style=\"width:100%;\" rows=\"5\">"+name.item_content+"</textarea></td>";      
                        row+="<td><a onclick=\"delIndex("+index+");\" style=\"cursor:pointer;\">Delete</a></td>";
                        row+="</tr>";
                        contentAll+=row;
                        //$("#tblIndex").append(row);
                        rowsIndex++;
                    }                   
                }
                $("#tblIndex").html(contentAll);
                //$("#provin").val(value);
            }
        }
        return false;
    }
    getDI(@ViewBag.id);
    function updateDI(id) {
        //showLoadingImage();
        var formdata = new FormData(); //FormData object    
        var xhr = new XMLHttpRequest();
        for (var i = 1; i <= rowsIndex; i++) {
            if (document.getElementById("rowsIndex"+i).style.display=='none') continue;
            //Appending each file to FormData object
            formdata.append("cbIndex"+i, document.getElementById("cbIndex" + i).value);
            formdata.append("chIndex"+i, document.getElementById("chIndex" + i).value);
            formdata.append("dIndex"+i, document.getElementById("dIndex" + i).value);
        }        
        formdata.append("count",rowsIndex);
        formdata.append("id",id);
        formdata.append("codevb",document.getElementById("code").value);
        xhr.open('POST', '/Document/updateDI');
        xhr.send(formdata);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                if (xhr.responseText=="0"){
                    alert("kiểm tra lại dữ liệu, có định dạng lỗi!");
                    document.getElementById("btnAddNew").disabled=false;
                    document.getElementById("btnAddNew").value="Save";
                }
                hideLoadingImage();
                alert("Ghi dữ liệu thành công !");
                window.location.href = "/Document/index";
            }
        }
        return false;
    }
    function uploadProcess() {
     
        var formdata = new FormData(); //FormData object
        var fileInput = document.getElementById('imageFile');
        for (i = 0; i < fileInput.files.length; i++) {
            //Appending each file to FormData object
            formdata.append(fileInput.files[i].name, fileInput.files[i]);
            //alert(fileInput.files[i].name);
            //return;
            break;
        }
        //formdata.append("filename", title);
        showLoadingImage();
        var xhr = new XMLHttpRequest();
        xhr.upload.addEventListener("progress", function (evt) {
            if (evt.lengthComputable) {
                var progress = Math.round(evt.loaded * 100 / evt.total);
                //$("#progressbar").progressbar("value", progress);
                //$("#progresslabelpr").css("width",progress+"%");
                $("#progresslabelpr").html("Đang phân tích từ khóa...<br><img src='/Images/loading.gif' >");
            }
        }, false);

        xhr.open('POST', '/Document/UploadDocProcess');
        xhr.send(formdata);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                if (xhr.responseText==""){
                    hideLoadingImage();    
                    alert("Văn bản này dùng phiên bản Word đã cũ. Xin mở bằng Word bản mới nhất(từ 2007 trở đi), Sau đó save as sang định dạng file .docx! Và upload lại!");
                }
                //$('#imageShow').html("<img src=\"" + xhr.responseText + "\" width=200 height=126>");
                //$('#image').val(xhr.responseText);
                //$('#dvimagefile').show();
                //hideLoadingImage();
                //alert("Upload thành công, nhập các thuộc tính cho văn bản.");
                //console.log(xhr.responseText);
                var items = xhr.responseText.split("____________");
                $('#name').val(items[1]);
                $('#code').val(items[0]);                
                //$('#link').val(items[3]);
                var text2 = items[8];
                var ddcat2 = document.getElementById('cat2');
                for (var i = 0; i < ddcat2.options.length; i++) {
                    if (ddcat2.options[i].text === text2) {
                        ddcat2.selectedIndex = i;
                        break;
                    }
                }
                items[6]=items[6].replace(items[0]+" ,","");
                $('#keyword1').val(items[2]);
                $('#keyword2').val(items[3]);
                $('#keyword3').val(items[4]);
                $('#keyword4').val(items[5]);
                $('#keyword5').val(items[6]);                
                $('#year').val(items[9]);
                $('#namelabel').show();
                //$('#namelabel').attr("src",'https://docs.google.com/viewer?url=@qlvb.Config.domain/Files/'+items[3]+'&embedded=true');   
                $('#viewdoc').attr("href",'https://docs.google.com/viewer?url=@qlvb.Config.domain/Files/'+items[7]+'&embedded=true');    
                checkDuplicate(items[0]);
                $('#viewdoc').show();
                $('#link').val(items[7]);
                //Xem cơ quan nào phát hành
                var text4=items[10];
                //alert(text4.toLowerCase());
                var ddcat4 = document.getElementById('cat4');
                for (var i = 0; i < ddcat4.options.length; i++) {
                    if (ddcat4.options[i].text.toLowerCase() === text4.toLowerCase()) {
                        ddcat4.selectedIndex = i;
                        break;
                    }
                }
                //Xem ai ký
                var text3=items[11];
                //alert(text4.toLowerCase());
                var ddcat3 = document.getElementById('cat3');
                for (var i = 0; i < ddcat3.options.length; i++) {
                    if (ddcat3.options[i].text.toLowerCase() === text3.toLowerCase()) {
                        ddcat3.selectedIndex = i;
                        break;
                    }
                }
                $('#date_publish').val(items[12]);
                hideLoadingImage();    
            }
        }
        return false;
    }
    function checkDuplicate(code){
        if (idDocument!=-1 && code=="@ViewBag.code") return;
        var formdata = new FormData(); //FormData object
        formdata.append("code", code);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/Document/checkDuplicate');
        xhr.send(formdata);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                //alert(xhr.responseText);
                if (xhr.responseText=="True"){
                    alert("Văn bản có mã là "+code+" đã tồn tại trong hệ thống. Kiểm tra lại!");
                    document.getElementById("code").focus();
                    return true;
                }
            }
        }
    }
    function chooseCat(type) {
        
        switch(type){
            case 1:
                if ($('#cat1').val() == -1) {
                    $('#addnewcat').show();
                    $('#addnewcatlabel').html("Thêm mới lĩnh vực văn bản");
                    currentTypeCat = 1;
                }
                break;
            case 2:
                if ($('#cat2').val() == -1) {
                    $('#addnewcat').show();
                    $('#addnewcatlabel').html("Thêm mới loại văn bản");
                    currentTypeCat = 2;
                }
                break;
            case 3:
                if ($('#cat3').val() == -1) {
                    $('#addnewcat').show();
                    $('#addnewcatlabel').html("Thêm mới người ký văn bản");
                    currentTypeCat = 3;
                }
                break;
            case 4:
                if ($('#cat4').val() == -1) {
                    $('#addnewcat').show();
                    $('#addnewcatlabel').html("Thêm mới cơ quan ban hành văn bản");
                    currentTypeCat = 4;
                }
                break;
        }
    }
    function addnewcat() {
        if (document.getElementById("addvalue").value == "") {
            alert("Nhập giá trị");
            document.getElementById("addvalue").focus();
            return;
        }
        var formdata = new FormData(); //FormData object
        document.getElementById("addnewcatbtn").disabled=true;
        formdata.append("type", currentTypeCat);
        formdata.append("value", document.getElementById("addvalue").value);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/Document/addNewCat');
        xhr.send(formdata);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var items = xhr.responseText.split("____________");
                switch (currentTypeCat) {
                    case 1:
                        $("#cat1").append("<option value=" + items[0] + ">" + items[1] + "</option>");
                        $("#cat1").val(items[0]);
                        break;
                    case 2:
                        $("#cat2").append("<option value=" + items[0] + ">" + items[1] + "</option>");
                        $("#cat2").val(items[0]);
                        break;
                    case 3:
                        $("#cat3").append("<option value=" + items[0] + ">" + items[1] + "</option>");
                        $("#cat3").val(items[0]);
                        break;
                    case 4:
                        $("#cat4").append("<option value=" + items[0] + ">" + items[1] + "</option>");
                        $("#cat4").val(items[0]);
                        break;
                }
                document.getElementById("addnewcatbtn").disabled=false;
                $('#addnewcat').hide();
            }
        }
    }
    function addNewDocument() {
        //alert(document.getElementById("date_publish").value);
        //return;
        if (idDocument==-1 && document.getElementById("imageFile").value == "") {
            alert("Chọn file văn bản");
            document.getElementById("imageFile").focus();
            return;
        }
        if (document.getElementById("name").value == "") {
            alert("Nhập tiêu đề");
            document.getElementById("name").focus();
            return;
        }
        if (document.getElementById("code").value == "") {
            alert("Nhập ký hiệu văn bản");
            document.getElementById("code").focus();
            return;
        }
        if (checkDuplicate(document.getElementById("code").value)){
            alert("Đã có văn bản này rồi!");
            document.getElementById("code").focus();
            return;
        }
        if (document.getElementById("keyword1").value == "") {
            alert("Nhập nội dung tóm tắt lấy từ tiêu đề của văn bản");
            document.getElementById("keyword1").focus();
            return;
        }
        if (document.getElementById("cat1").value == -2) {
            alert("Nhập lĩnh vực văn bản");
            document.getElementById("cat1").focus();
            return;
        }
        if (document.getElementById("cat2").value == -2) {
            alert("Nhập loại văn bản");
            document.getElementById("cat2").focus();
            return;
        }
        if (document.getElementById("cat3").value == -2) {
            alert("Nhập người ký văn bản");
            document.getElementById("cat3").focus();
            return;
        }
        if (document.getElementById("cat4").value == -2) {
            alert("Nhập cơ quan ban hành");
            document.getElementById("cat4").focus();
            return;
        }
        if (document.getElementById("year").value == -2) {
            alert("Nhập năm ban hành");
            document.getElementById("year").focus();
            return;
        }
        if (document.getElementById("date_publish").value =="") {
            alert("Nhập ngày ban hành");
            document.getElementById("date_publish").focus();
            return;
        }
        //if (document.getElementById("date_start").value =="") {
        //    alert("Nhập ngày có hiệu lực");
        //    document.getElementById("date_start").focus();
        //    return;
        //}
        //if (CKEDITOR.instances.full_content.getData()=="") {
        //    alert("Nhập toàn văn");
        //    document.getElementById("full_content").focus();
        //    return;
        //}
        if (!document.getElementById("cbIndex1") || document.getElementById("cbIndex1").value==""){
            alert("Nhập các chương điều");
            document.getElementById("cbIndex1").focus();
            return;
        }
        var status=0;
        if (document.getElementById("status").checked==false) status=1;
        document.getElementById("btnAddNew").value="Saving...";
        document.getElementById("btnAddNew").disabled=true;
        var formdata = new FormData(); //FormData object

        formdata.append("id", idDocument);
        formdata.append("name", document.getElementById("name").value);
        formdata.append("code", document.getElementById("code").value);
        formdata.append("link", document.getElementById("link").value);
        formdata.append("keyword1", document.getElementById("keyword1").value);
        formdata.append("keyword2", document.getElementById("keyword2").value);
        formdata.append("keyword3", document.getElementById("keyword3").value);
        formdata.append("keyword4", document.getElementById("keyword4").value);
        formdata.append("keyword5", document.getElementById("keyword5").value);
        formdata.append("cat1", document.getElementById("cat1").value);
        formdata.append("cat2", document.getElementById("cat2").value);
        formdata.append("cat3", document.getElementById("cat3").value);
        formdata.append("cat4", document.getElementById("cat4").value);
        formdata.append("year", document.getElementById("year").value);
        formdata.append("related_id", document.getElementById("related_id").value);
        formdata.append("be_linked", document.getElementById("be_linked").value);
        formdata.append("link_to", document.getElementById("link_to").value);
        formdata.append("link_to_over_date", document.getElementById("link_to_over_date").value);
        formdata.append("date_publish", document.getElementById("date_publish").value);
        formdata.append("date_start", document.getElementById("date_start").value);
        formdata.append("full_content", "");
        formdata.append("status", status);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/Document/addNewDocument');
        xhr.send(formdata);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                if (xhr.responseText!="0"){
                    //alert("Saved!");
                    updateDI(xhr.responseText);
                    //window.location.href="/Document/Index";
                }else{
                    alert("Lỗi định dạng văn bản");
                }
                //document.getElementById("btnAddNew").disabled=false;
                //document.getElementById("btnAddNew").value="Save";
            }
        }
    }
    function autosearch(e,type) {
        var code = document.getElementById("link_to").value;
        if (type==1) code=document.getElementById("be_linked").value;
        if (type==2) code=document.getElementById("link_to_over_date").value;
        //Tách code ra
        var arrcode=code.split(',');
        var tempcode=arrcode[arrcode.length-1].trim();
        urlSearch = '/Document/getDocByCode?code=';
        if (type==0){
            $('#link_to').autocomplete({
                source: urlSearch + tempcode,
                select: function (event, ui) {
                    if ($(event.target).val().lastIndexOf(tempcode)==0) $(event.target).val("");
                    $(event.target).val($(event.target).val().replace(" , "+tempcode,"")+" , "+ui.item.value+" , "); 
                    
                    //alert(ui.item.id);
                    return false;
                },
                minLength: 1
            });
        }else if (type==1){
            $('#be_linked').autocomplete({
                source: urlSearch + tempcode,
                select: function (event, ui) {
                    if ($(event.target).val().lastIndexOf(tempcode)==0) $(event.target).val("");
                    $(event.target).val($(event.target).val().replace(" , "+tempcode,"")+" , "+ui.item.value+" , ");                
                    //alert(ui.item.id);
                    return false;
                },
                minLength: 1
            });
        }else if (type==2){
            var keyword=document.getElementById("lookupvalue").value
            urlSearch = '/Document/getDoc?keyword=';
            $('#lookupvalue').autocomplete({
                source: urlSearch + keyword,
                select: function (event, ui) {                  
                    window.open("/Document/Details/"+ui.item.id,"_blank");
                    return false;
                },
                minLength: 1
            });
        }
    }
    if ("@ViewBag.user"!=""){
        $("#loginli").hide();
        $("#logoutli").show();
    }
    function showlookup(){
        if (document.getElementById("lookup").style.display=='none'){
            document.getElementById("lookup").style.display="block";
        }else{
            document.getElementById("lookup").style.display="none";
        }
    }
</script>